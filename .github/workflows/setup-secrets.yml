name: Setup Secrets for Development

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to setup'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup secrets directory
        run: |
          mkdir -p secrets
          chmod 700 secrets

      - name: Generate SECRET_KEY
        run: |
          openssl rand -base64 50 > secrets/secret_key.txt
          chmod 600 secrets/secret_key.txt

      - name: Generate JWT keys
        run: |
          openssl genrsa -out secrets/jwt_rsa 4096
          openssl rsa -in secrets/jwt_rsa -pubout -out secrets/jwt_rsa.pub
          chmod 600 secrets/jwt_rsa secrets/jwt_rsa.pub

      - name: Generate admin password
        run: |
          openssl rand -base64 32 > secrets/admin_password.txt
          chmod 600 secrets/admin_password.txt

      - name: Generate database password
        run: |
          openssl rand -base64 24 > secrets/database_password.txt
          chmod 600 secrets/database_password.txt

      - name: Create .env file
        run: |
          cat > .env << EOF
          # Saleor Production Environment Variables
          # Generated automatically - DO NOT COMMIT TO GIT

          # Database
          DATABASE_URL=postgres://saleor:\$(cat secrets/database_password.txt)@db:5432/saleor
          DB_PASSWORD=\$(cat secrets/database_password.txt)

          # Celery
          CELERY_BROKER_URL=redis://redis:6379/1

          # Email
          DEFAULT_FROM_EMAIL=noreply@vitoesposito.it
          EMAIL_URL=smtp://localhost:1025

          # Security (generati automaticamente)
          SECRET_KEY=\$(cat secrets/secret_key.txt)
          HTTP_IP_FILTER_ALLOW_LOOPBACK_IPS=False

          # Dashboard
          DASHBOARD_URL=https://dashboard.vitoesposito.it/

          # CORS Configuration
          ALLOWED_GRAPHQL_ORIGINS=https://dashboard.vitoesposito.it,https://vitoesposito.it,https://api.vitoesposito.it,https://saleor-api.vitoesposito.it,https://cms.vitoesposito.it,https://storage.vitoesposito.it,https://mailpit.vitoesposito.it
          ALLOWED_HOSTS=saleor-api.vitoesposito.it,localhost,127.0.0.1
          ALLOWED_CLIENT_HOSTS=saleor-api.vitoesposito.it,dashboard.vitoesposito.it,vitoesposito.it,api.vitoesposito.it,cms.vitoesposito.it,storage.vitoesposito.it,mailpit.vitoesposito.it

          # Production settings
          DEBUG=False
          INTERNAL_IPS=127.0.0.1
          PLAYGROUND_ENABLED=False

          # Admin Configuration
          ADMIN_EMAIL=admin@vitoesposito.it
          ADMIN_PASSWORD=\$(cat secrets/admin_password.txt)
          ADMIN_FIRST_NAME=Admin
          ADMIN_LAST_NAME=Vito

          # JWT Keys (caricate automaticamente da secrets/)
          # RSA_PRIVATE_KEY e RSA_PUBLIC_KEY sono caricate dai file secrets/
          EOF

      - name: Upload secrets as artifact
        uses: actions/upload-artifact@v4
        with:
          name: saleor-secrets-${{ github.run_id }}
          path: |
            secrets/
            .env
          retention-days: 1

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '🔐 Secrets generated! Download the artifact `saleor-secrets-${{ github.run_id }}` and extract to your project root.'
            })
